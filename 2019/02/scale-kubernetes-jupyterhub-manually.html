<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Scale Kubernetes manually on Jetstream | Andrea Zonca's blog</title>
        <meta name="author" content="Andrea Zonca">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">

        <link rel="alternate" type="application/atom+xml" title="Andrea Zonca's blog blog atom feed"
              href="/feeds/all.atom.xml" />

        <link rel="stylesheet" href="/theme/css/normalize.min.css">
        <link rel="stylesheet" href="/theme/css/fonts/proximanova.css">
        <link rel="stylesheet" href="/theme/css/fonts/ss-social.css">
        <link rel="stylesheet" href="/theme/css/fonts/ss-standard.css">
        <link rel="stylesheet" href="/theme/css/pygments.css">
        <!-- <link rel="stylesheet" href="/theme/css/ipython.css"> -->
        <link rel="stylesheet" href="/theme/css/main.css">
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/7.3/highlight.min.js"></script>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/7.3/styles/github.min.css">
<script src="/theme/js/github-files/src/main/javascript/github-files.js"> </script>

    </head>
    <body>
        <div class="header">
            <div class="navbar">
              <a href="/" class="ss-icon" title="home">home</a>
              <a href="/tags.html" class="ss-icon" title="tags">tag</a>
              <a href="http://about.me/andreazonca" class="ss-icon" title="about">user</a>
              <a href="http://twitter.com/andreazonca" class="ss-icon ss-social" title="on twitter">twitter</a>
              <a href="http://github.com/zonca" class="ss-icon ss-social" title="on github">octocat</a>
              <a href="/feeds/all.atom.xml" class="ss-icon ss-social" title="rss feed">rss</a>
              <a href="mailto:andrea.zonca|on the google mail service" class="ss-icon" title="email me">mail</a>
            </div>
        </div>

        <div id="content">
<div class="post">
    <article>
        <header>
            <h1>Scale Kubernetes manually on Jetstream</h1>
        </header>
        <div class='post-content'>
            <p>We would like to modify the number of Openstack virtual machines available to Kubernetes.
Ideally we would like to do this automatically based on the load on JupyterHub, that is the
target.
For now we will increase and decrease the size manually.
This can be useful for example if you make a test deployment with only 1 worker node a week
before a workshop and then scale it up to 10 or more instances the day before the workshop
begins.</p>
<p>This assumes you have <a href="http://zonca.github.io/2019/02/kubernetes-jupyterhub-jetstream-kubespray.html">deployed Kubernetes and JupyterHub already</a></p>
<h2>Create a new Openstack Virtual Machine with Terraform</h2>
<p>To add nodes, enter the <code>inventory/$CLUSTER</code> folder, we can edit <code>cluster.tf</code> and increase <code>number_of_k8s_nodes_no_floating_ip</code>, in my testing I have increased it from 1 to 3.</p>
<p>Then we can run again <code>terraform_apply.sh</code>, this should run Terraform and create a new resource:</p>
<div class="highlight"><pre><span></span><span class="n">Apply</span> <span class="n">complete</span><span class="o">!</span> <span class="n">Resources</span><span class="p">:</span> <span class="mi">2</span> <span class="n">added</span><span class="p">,</span> <span class="mi">0</span> <span class="n">changed</span><span class="p">,</span> <span class="mi">0</span> <span class="n">destroyed</span><span class="p">.</span>
</pre></div>


<p>Check first that your machine has booted correctly running:</p>
<div class="highlight"><pre><span></span><span class="n">openstack</span> <span class="n">server</span> <span class="n">list</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">+</span><span class="c1">--------------------------------------+---------------------+--------+--------------------------------------------+-------------------------------------+----------+</span>
<span class="o">|</span> <span class="n">ID</span>                                   <span class="o">|</span> <span class="n">Name</span>                <span class="o">|</span> <span class="n">Status</span> <span class="o">|</span> <span class="n">Networks</span>                                   <span class="o">|</span> <span class="n">Image</span>                               <span class="o">|</span> <span class="n">Flavor</span>   <span class="o">|</span>
<span class="o">+</span><span class="c1">--------------------------------------+---------------------+--------+--------------------------------------------+-------------------------------------+----------+</span>
<span class="o">|</span> <span class="mi">4</span><span class="n">ea73e65</span><span class="o">-</span><span class="mi">2</span><span class="n">bff</span><span class="o">-</span><span class="mi">42</span><span class="n">c9</span><span class="o">-</span><span class="mi">8</span><span class="n">c4b</span><span class="o">-</span><span class="mi">6</span><span class="n">c6928ad1b77</span> <span class="o">|</span> <span class="n">zonca</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="n">nf</span><span class="o">-</span><span class="mi">3</span> <span class="o">|</span> <span class="n">ACTIVE</span> <span class="o">|</span> <span class="n">zonca_k8s_network</span><span class="o">=</span><span class="mi">10</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">7</span>                 <span class="o">|</span> <span class="n">JS</span><span class="o">-</span><span class="n">API</span><span class="o">-</span><span class="n">Featured</span><span class="o">-</span><span class="n">Ubuntu18</span><span class="o">-</span><span class="nb">Dec</span><span class="o">-</span><span class="mi">7</span><span class="o">-</span><span class="mi">2018</span> <span class="o">|</span> <span class="n">m1</span><span class="p">.</span><span class="n">small</span> <span class="o">|</span>                                                       <span class="o">|</span> <span class="mi">0</span><span class="n">cf1552e</span><span class="o">-</span><span class="n">ef0c</span><span class="o">-</span><span class="mi">48</span><span class="n">b0</span><span class="o">-</span><span class="n">ac24</span><span class="o">-</span><span class="mi">571301809273</span> <span class="o">|</span> <span class="n">zonca</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="n">nf</span><span class="o">-</span><span class="mi">2</span> <span class="o">|</span> <span class="n">ACTIVE</span> <span class="o">|</span> <span class="n">zonca_k8s_network</span><span class="o">=</span><span class="mi">10</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">11</span>                <span class="o">|</span> <span class="n">JS</span><span class="o">-</span><span class="n">API</span><span class="o">-</span><span class="n">Featured</span><span class="o">-</span><span class="n">Ubuntu18</span><span class="o">-</span><span class="nb">Dec</span><span class="o">-</span><span class="mi">7</span><span class="o">-</span><span class="mi">2018</span> <span class="o">|</span> <span class="n">m1</span><span class="p">.</span><span class="n">small</span> <span class="o">|</span>                                                       <span class="o">|</span> <span class="n">e3731cde</span><span class="o">-</span><span class="n">cf6e</span><span class="o">-</span><span class="mi">4556</span><span class="o">-</span><span class="mi">8</span><span class="n">bda</span><span class="o">-</span><span class="mi">0</span><span class="n">eebc0c7f08e</span> <span class="o">|</span> <span class="n">zonca</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">master</span><span class="o">-</span><span class="mi">1</span>  <span class="o">|</span> <span class="n">ACTIVE</span> <span class="o">|</span> <span class="n">zonca_k8s_network</span><span class="o">=</span><span class="mi">10</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">9</span><span class="p">,</span> <span class="n">xxx</span><span class="p">.</span><span class="n">xxx</span><span class="p">.</span><span class="n">xxx</span><span class="p">.</span><span class="n">xx</span> <span class="o">|</span> <span class="n">JS</span><span class="o">-</span><span class="n">API</span><span class="o">-</span><span class="n">Featured</span><span class="o">-</span><span class="n">Ubuntu18</span><span class="o">-</span><span class="nb">Dec</span><span class="o">-</span><span class="mi">7</span><span class="o">-</span><span class="mi">2018</span> <span class="o">|</span> <span class="n">m1</span><span class="p">.</span><span class="n">small</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">443</span><span class="n">c6861</span><span class="o">-</span><span class="mi">1</span><span class="n">a13</span><span class="o">-</span><span class="mi">4080</span><span class="o">-</span><span class="n">b5a3</span><span class="o">-</span><span class="n">e005bb34a77c</span> <span class="o">|</span> <span class="n">zonca</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="n">nf</span><span class="o">-</span><span class="mi">1</span> <span class="o">|</span> <span class="n">ACTIVE</span> <span class="o">|</span> <span class="n">zonca_k8s_network</span><span class="o">=</span><span class="mi">10</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">3</span>                 <span class="o">|</span> <span class="n">JS</span><span class="o">-</span><span class="n">API</span><span class="o">-</span><span class="n">Featured</span><span class="o">-</span><span class="n">Ubuntu18</span><span class="o">-</span><span class="nb">Dec</span><span class="o">-</span><span class="mi">7</span><span class="o">-</span><span class="mi">2018</span> <span class="o">|</span> <span class="n">m1</span><span class="p">.</span><span class="n">small</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">--------------------------------------+---------------------+--------+--------------------------------------------+-------------------------------------+----------+</span>
</pre></div>


<p>As expected we have now 1 master and 3 nodes.</p>
<p>Then change the folder to the root of the repository and check you can connect to it with:</p>
<div class="highlight"><pre><span></span><span class="n">ansible</span> <span class="o">-</span><span class="n">i</span> <span class="n">inventory</span><span class="o">/</span><span class="err">$</span><span class="k">CLUSTER</span><span class="o">/</span><span class="n">hosts</span> <span class="o">-</span><span class="n">m</span> <span class="n">ping</span> <span class="k">all</span>
</pre></div>


<p>If any of the new nodes is Unreachable, you can try rebooting them with:</p>
<div class="highlight"><pre><span></span><span class="n">openstack</span> <span class="n">server</span> <span class="n">reboot</span> <span class="n">zonca</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="n">nf</span><span class="o">-</span><span class="mi">3</span>
</pre></div>


<h3>Configure the new instances for Kubernetes</h3>
<p><code>kubespray</code> has a special playbook <code>scale.yml</code> that impacts as little as possible the nodes
already running.
I have created a script <code>k8s_scale.sh</code> in the root folder of my <code>jetstream_kubespray</code> repository,
launch:</p>
<div class="highlight"><pre><span></span><span class="n">bash</span> <span class="n">k8s_scale</span><span class="p">.</span><span class="n">sh</span>
</pre></div>


<p><a href="https://github.com/kubernetes-sigs/kubespray/blob/master/docs/getting-started.md#adding-nodes">See for reference the <code>kubespray</code> documentation</a></p>
<p>Once this completes (re-run it if it stops at some point), you should see what Ansible modified:</p>
<div class="highlight"><pre><span></span><span class="n">zonca</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">master</span><span class="o">-</span><span class="mi">1</span>         <span class="p">:</span> <span class="n">ok</span><span class="o">=</span><span class="mi">25</span>   <span class="n">changed</span><span class="o">=</span><span class="mi">3</span>    <span class="n">unreachable</span><span class="o">=</span><span class="mi">0</span>    <span class="n">failed</span><span class="o">=</span><span class="mi">0</span>                                   <span class="n">zonca</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="n">nf</span><span class="o">-</span><span class="mi">1</span>        <span class="p">:</span> <span class="n">ok</span><span class="o">=</span><span class="mi">247</span>  <span class="n">changed</span><span class="o">=</span><span class="mi">16</span>   <span class="n">unreachable</span><span class="o">=</span><span class="mi">0</span>    <span class="n">failed</span><span class="o">=</span><span class="mi">0</span>
<span class="n">zonca</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="n">nf</span><span class="o">-</span><span class="mi">2</span>        <span class="p">:</span> <span class="n">ok</span><span class="o">=</span><span class="mi">257</span>  <span class="n">changed</span><span class="o">=</span><span class="mi">77</span>   <span class="n">unreachable</span><span class="o">=</span><span class="mi">0</span>    <span class="n">failed</span><span class="o">=</span><span class="mi">0</span>                                   <span class="n">zonca</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="n">nf</span><span class="o">-</span><span class="mi">3</span>        <span class="p">:</span> <span class="n">ok</span><span class="o">=</span><span class="mi">257</span>  <span class="n">changed</span><span class="o">=</span><span class="mi">77</span>   <span class="n">unreachable</span><span class="o">=</span><span class="mi">0</span>    <span class="n">failed</span><span class="o">=</span><span class="mi">0</span>
</pre></div>


<p>At this point you should check the nodes are seen by Kubernetes with <code>kubectl get nodes</code>:</p>
<div class="highlight"><pre><span></span><span class="n">NAME</span>                  <span class="n">STATUS</span>   <span class="n">ROLES</span>    <span class="n">AGE</span>     <span class="k">VERSION</span>                                                       <span class="n">zonca</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">master</span><span class="o">-</span><span class="mi">1</span>    <span class="n">Ready</span>    <span class="n">master</span>   <span class="mi">4</span><span class="n">h29m</span>   <span class="n">v1</span><span class="p">.</span><span class="mi">12</span><span class="p">.</span><span class="mi">5</span>                                                       <span class="n">zonca</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="n">nf</span><span class="o">-</span><span class="mi">1</span>   <span class="n">Ready</span>    <span class="n">node</span>     <span class="mi">4</span><span class="n">h28m</span>   <span class="n">v1</span><span class="p">.</span><span class="mi">12</span><span class="p">.</span><span class="mi">5</span>                                                       <span class="n">zonca</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="n">nf</span><span class="o">-</span><span class="mi">2</span>   <span class="n">Ready</span>    <span class="n">node</span>     <span class="mi">5</span><span class="n">m11s</span>   <span class="n">v1</span><span class="p">.</span><span class="mi">12</span><span class="p">.</span><span class="mi">5</span>                                                       <span class="n">zonca</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="n">nf</span><span class="o">-</span><span class="mi">3</span>   <span class="n">Ready</span>    <span class="n">node</span>     <span class="mi">5</span><span class="n">m11s</span>   <span class="n">v1</span><span class="p">.</span><span class="mi">12</span><span class="p">.</span><span class="mi">5</span>
</pre></div>


<h2>Reduce the number of nodes</h2>
<p>Kubernetes is built to be resilient to node losses, so you could just brutally delete a node with <code>openstack server delete</code>. However, there is a dedicated playbook, <code>remove-node.yml</code>, to remove a node cleanly migrating any running services to other nodes and lowering the risk of anything malfunctioning.
I created a script <code>k8s_remove_node.sh</code>, pass the name of the node you would like to eliminate (or a comma separated list of many names):</p>
<div class="highlight"><pre><span></span><span class="n">bash</span> <span class="n">k8s_remove_node</span><span class="p">.</span><span class="n">sh</span> <span class="n">zonca</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="n">nf</span><span class="o">-</span><span class="mi">3</span>
</pre></div>


<p>Now the node has disappeared by <code>kubectl get nodes</code> but the underlying Openstack instance is still running, delete it with:</p>
<div class="highlight"><pre><span></span><span class="n">openstack</span> <span class="n">server</span> <span class="k">delete</span> <span class="n">zonca</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="n">nf</span><span class="o">-</span><span class="mi">3</span>
</pre></div>


<p>For consistency you could now modify <code>inventory/$CLUSTER/cluster.tf</code> and reduce the number of nodes accordingly.</p>
        </div>
    </article>

    <div class="metadata">
        <ul>
            <li>
                <strong>Published:</strong>
                <i><time datetime="2019-02-22T21:00:00-08:00">Fri 22 February 2019</time></i>
            </li>
            <li>
                <strong>In:</strong>
                <a href="http://zonca.github.io/category/misc.html">misc</a>
            </li>
            <li>
                <strong>Tags:</strong>
<a href="http://zonca.github.io/tag/kubernetes.html">kubernetes</a> 
<a href="http://zonca.github.io/tag/kubespray.html">kubespray</a> 
<a href="http://zonca.github.io/tag/jetstream.html">jetstream</a> 
<a href="http://zonca.github.io/tag/jupyterhub.html">jupyterhub</a> 
            </li>
            <li>
                <strong>Written by:</strong>
                <a href="http://zonca.github.io/author/andrea-zonca.html">Andrea Zonca</a>
            </li>
        </ul>
    </div>
</div>
        </div>

        <footer>
        </footer>


        <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-15291408-1']);
        _gaq.push(['_trackPageview']);

        (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
        </script>
<script>
$(document).ready(function () {
    $("pre").each(function(i, e){
        console.log(e);
        if (e.textContent.match("^github")) {
            var parts = e.textContent.split(":")[1].split("/");
            $.getGithubFileByFilePath(parts[0], parts[1], parts.slice(2).join("/"), function(contents)
            {
                e.textContent = contents;
                hljs.highlightBlock(e);
            } );
        };
    });
 });
</script>
    </body>
</html>